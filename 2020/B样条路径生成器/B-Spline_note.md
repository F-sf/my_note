# B样条

## 特性

设计和工程中常用的曲线/曲面生成工具。可解决贝塞尔曲线牵一发而动全身的问题，具有局部可调性。

## 原理

### 基本概念

>  **决定一个曲线的输入参数有阶次k、控制点ControlPoints(cps)、节点knots。**

#### 阶次k

* 阶次越高，曲线越高阶平滑，k=1时会生成折线。

#### 控制点ControlPoints

* 实际控制B样条的点，用于设计曲线时与用户交互。

#### 节点knots

* 计算基函数表时的重要依据，其长度严格等于**控制点个数+阶次k+1**。

* 一般选择其取值范围在[0,1]之间，非严格单调递增。

* 其最常用的生成方式为均布生成和Clamped生成，均布生成即在[0,1]间均分；Clamped生成为两端各自填上k+1个0和1，然后中间部分再进行均分。
* 若要用本文所用方法进行曲率半径计算，则必须使用Clamped方法生成节点，否则无法正常计算曲率半径。

> **除了决定性参数之外，还有两个重要概念：基函数表BaseFunctionTbl、点生成依据t(作用类似参数方程)**

#### 基函数表BaseFunctionTbl

* 用于计算最终各控制点加权时使用的基函数
* 手写B样条的核心问题在于基函数表的计算和生成

#### 参数t

* 取值范围和节点取值范围一致，一般为[0,1]，用于表示曲线进行到哪个部分的参数

### 生成原理

基函数表是一个**knots数目-1**行，**阶数k+1**列的表，其生成方式是递归计算，第一列遵循一个确定的生成方式，其他列进行则是递归生成。总体结构如下图：

> 第一个下标表可理解为节点下标或控制点下标，第二个下标表示阶数deg

![BaseFunctionTbl](figures\BaseFunctionTbl.jpg)

第一列的生成公式如下，由t在knots中的位置决定其为0/1：![基函数表第一列生成公式](figures\formula1.jpg)

后续列的递归生成公式如下，依赖关系如上分叉图所示，递归计算至最后一列，此时下标为曲线阶次k：

![基函数表后序列递归公式](figures\formula2.jpg)

代码实现中，每输入一个新t，根据以上规则计算一次基函数表

**最终计算方法如下**

对所有的控制点进行加权，权重值就是基函数表最后一列的前n项，分别对应n个控制点。

实现时因权重和有时会不等于1，在每次计算前对权重进行了归一化。

![最终计算公式](figures\formula3.jpg)

最后计算所得即为当曲线参数为t时，曲线上点的坐标。

## 求导

> https://pages.mtu.edu/~shene/COURSES/cs3621/NOTES/spline/B-spline/bspline-derv.html
>
> 及论文《B样条曲线曲率简易求解算法》
>
> 都有方法讲解，但未解释原理

​        求导的主要思路是依据一个理论推导得到的公式将求导结果表示为一个新的B样条曲线，然后对其计算。多次求导只需多次执行此方法即可。

对于一个**阶次为p，n+1个控制点P，n+1+p+1个Clamped节点u** 的B样条曲线，其一阶导可表示如下

![求导推导公式](figures\formula4.jpg)

上图公式等价于一个新的B样条曲线的最终计算公式，该曲线的确定参数如下：

* 阶次k1 = p - 1

* 节点knots1 = u掐头去尾，即去掉一个重复的0和1

* 控制点个数为n+1-1个，计算方式与上图一致，为：
  $$
  Q_i=p\frac{P_{i+1}-P_i}{u_{i+p+1}-u_{i+1}}
  $$

而对此新的B样条曲线进行求值就能得到原曲线的一阶导数

同理对此新曲线再次执行该方法，就可得到二阶导数**(但要求原曲线有k>=2)**

## 求曲率和半径

> 求曲率需要原曲线的一阶和二阶导数，故应保证原曲线为二阶及以上
>
> 方法参考论文《B样条曲线曲率简易求解算法》
>

曲率K计算公式：

![曲率公式](figures\formula5.jpg)

半径可直接取abs(1/K)